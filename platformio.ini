; ================================
; ESP32-S3 N16R8 (16MB Flash / 8MB PSRAM)
; RED808 Drum Machine - Optimized Build
; ================================

[platformio]
data_dir = data_gz

[env:esp32-s3-devkitc-1]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; ================================
; CONFIGURACIÓN DE MEMORIA (N16R8)
; ================================
; Flash: 16MB (Quad IO)
board_build.flash_mode = qio
board_upload.flash_size = 16MB
board_upload.maximum_size = 16777216

; PSRAM: 8MB (Octal mode - OPI)
board_build.arduino.memory_type = qio_opi
board_build.psram_type = opi

; ================================
; Particiones (Custom 11MB para Samples)
; ================================
board_build.partitions = partitions_custom.csv
board_build.filesystem = littlefs

; ================================
; Flags de Compilación (Optimizado)
; ================================
; Excluir AudioEngine.cpp (legacy I2S, reemplazado por SPIMaster/Daisy)
build_src_filter = +<*> -<AudioEngine.cpp> -<AudioEngine.h>

build_flags =
    -DBOARD_HAS_PSRAM
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    ; --- AsyncTCP: stack grande para JSON processing en callbacks ---
    -DCONFIG_ASYNC_TCP_STACK_SIZE=32768
    -DCONFIG_ASYNC_TCP_PRIORITY=10
    -DCONFIG_ASYNC_TCP_QUEUE_SIZE=32
    -DCONFIG_ASYNC_TCP_RUNNING_CORE=0
    ; --- Optimizaciones de rendimiento ---
    -O2
    -DCORE_DEBUG_LEVEL=1
    ; --- WiFi/Network optimizaciones para mínima latencia ---
    -DCONFIG_ESP_WIFI_AMPDU_TX_ENABLED=1
    -DCONFIG_ESP_WIFI_AMPDU_RX_ENABLED=1
    -DCONFIG_LWIP_IRAM_OPTIMIZATION=1
    -DCONFIG_LWIP_TCP_SND_BUF_DEFAULT=11440
    -DCONFIG_LWIP_TCP_WND_DEFAULT=11440
    -DCONFIG_LWIP_TCP_RECVMBOX_SIZE=16
    -DCONFIG_LWIP_UDP_RECVMBOX_SIZE=16
    -DCONFIG_LWIP_TCPIP_RECVMBOX_SIZE=48
    -DCONFIG_ESP_WIFI_TX_BUFFER_TYPE=0
    -DCONFIG_ESP_WIFI_STATIC_TX_BUFFER_NUM=16
    -DCONFIG_ESP_WIFI_DYNAMIC_RX_BUFFER_NUM=32
    -DCONFIG_ESP_WIFI_RX_BA_WIN=16

; ================================
; Upload & Monitor
; ================================
upload_speed = 921600
monitor_speed = 115200
monitor_filters = esp32_exception_decoder, time
build_type = release

extra_scripts =
    pre:tools/prepare_data_gz.py

; ================================
; Librerías
; ================================
lib_deps =
    adafruit/Adafruit NeoPixel@^1.12.0
    ottowinter/ESPAsyncWebServer-esphome@^3.1.0
    bblanchon/ArduinoJson@^6.21.3