<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RED808 Drum Machine</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="keyboard-styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="logo">RED<span>808</span></h1>
                <div class="status">
                    <span id="statusDot" class="status-dot"></span>
                    <span id="statusText">Conectando...</span>
                </div>
            </div>
            <div class="header-controls">
                <!-- BPM -->
                <div class="hdr-ctrl" id="meter-bpm">
                    <span class="hdr-ctrl-label">BPM <span class="hdr-ctrl-hint">[ / ]</span></span>
                    <input type="range" id="tempoSlider" min="60" max="200" value="110" class="hdr-slider">
                    <span class="hdr-ctrl-value" id="tempoValue">110</span>
                    <!-- keep hidden meter IDs for JS compat -->
                    <span id="meterBpmValue" style="display:none">110</span>
                    <span id="meterBpmBar" style="display:none"></span>
                </div>
                <!-- VOL SEQ -->
                <div class="hdr-ctrl" id="meter-seq-volume">
                    <span class="hdr-ctrl-label">VOL SEQ <span class="hdr-ctrl-hint">A/S</span></span>
                    <input type="range" id="sequencerVolumeSlider" min="0" max="150" value="100" class="hdr-slider">
                    <span class="hdr-ctrl-value" id="sequencerVolumeValue">100</span>
                    <span id="meterSequencerVolumeValue" style="display:none">100%</span>
                    <span id="meterSequencerVolumeBar" style="display:none"></span>
                </div>
                <!-- VOL PADS -->
                <div class="hdr-ctrl" id="meter-live-volume">
                    <span class="hdr-ctrl-label">VOL PADS <span class="hdr-ctrl-hint">-/+</span></span>
                    <input type="range" id="liveVolumeSlider" min="0" max="150" value="100" class="hdr-slider">
                    <span class="hdr-ctrl-value" id="liveVolumeValue">100</span>
                    <span id="meterLiveVolumeValue" style="display:none">100%</span>
                    <span id="meterLiveVolumeBar" style="display:none"></span>
                </div>
                <!-- V / M / S global buttons -->
                <div class="hdr-vsm-btns">
                    <select id="hdrTrackSelect" class="hdr-track-select" title="Seleccionar track">
                        <option value="-1">TRACK</option>
                        <option value="0">BD</option>
                        <option value="1">SD</option>
                        <option value="2">CH</option>
                        <option value="3">OH</option>
                        <option value="4">CY</option>
                        <option value="5">CP</option>
                        <option value="6">RS</option>
                        <option value="7">CB</option>
                        <option value="8">LT</option>
                        <option value="9">MT</option>
                        <option value="10">HT</option>
                        <option value="11">MA</option>
                        <option value="12">CL</option>
                        <option value="13">HC</option>
                        <option value="14">MC</option>
                        <option value="15">LC</option>
                    </select>
                    <button class="hdr-btn hdr-btn-v" id="hdrVolBtn" title="Volumen track seleccionado">V</button>
                    <button class="hdr-btn hdr-btn-m" id="hdrMuteBtn" title="Mute track seleccionado">M</button>
                    <button class="hdr-btn hdr-btn-s" id="hdrSoloBtn" title="Solo track seleccionado">S</button>
                </div>
                <!-- V popup slider -->
                <div class="hdr-vol-popup" id="hdrVolPopup" style="display:none">
                    <span class="hdr-vol-popup-label" id="hdrVolPopupLabel">TRACK VOL</span>
                    <input type="range" id="hdrVolPopupSlider" min="0" max="150" value="100" class="hdr-slider">
                    <span class="hdr-ctrl-value" id="hdrVolPopupValue">100</span>
                </div>
                <!-- SQNCR status -->
                <div class="meter meter-sequencer" id="meter-sequencer">
                    <span class="meter-label">SQNCR</span>
                    <div class="meter-value" id="meterSequencerStatus">STOP</div>
                    <div class="meter-bar">
                        <span id="meterSequencerStatusBar"></span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation Bar -->
        <nav class="tab-navigation">
            <button class="tab-btn active" data-tab="performance">üéπ LIVE PADS</button>
            <button class="tab-btn" data-tab="xtra-pads">üé≤ XTRA PADS</button>
            <button class="tab-btn" data-tab="sequencer">üéµ SEQUENCER</button>
            <button class="tab-btn" data-tab="volumes">üéöÔ∏è VOLUMENES</button>
            <button class="tab-btn" data-tab="fx">üîä FX</button>
            <button class="tab-btn" data-tab="midi">üéπ MIDI</button>
            <button class="tab-btn" data-tab="info">üìä INFO</button>
        </nav>

        <!-- TAB: Performance (Live Pads) -->
        <div id="tab-performance" class="tab-content active">
            <!-- Live Pads Section -->
            <section id="section-pads" class="pads-section" data-section="pads" data-title="Live Pads">
                <div class="pads-header">
                    <h2>LIVE PADS</h2>
                    <span class="sync-badge">üîó SYNCED</span>
                    <label class="sync-leds-toggle" title="Sync LEDs: los pads se iluminan al ritmo del sequencer">
                        <input type="checkbox" id="syncLedsToggle">
                        <span class="sync-leds-slider"></span>
                        <span class="sync-leds-label">üí° SYNC LEDS</span>
                    </label>
                    <div class="pad-layout-selector">
                        <span class="layout-sel-label">GRID</span>
                        <button class="pls-btn" data-cols="2">2</button>
                        <button class="pls-btn active" data-cols="4">4</button>
                        <button class="pls-btn" data-cols="8">8</button>
                    </div>
                    <button id="loadSampleListsBtn" class="btn btn-load-samples" title="Recargar Samplers">
                        üîÑ
                    </button>
                </div>
                <div class="pads-grid" id="padsGrid">
                    <!-- Los pads se generar√°n din√°micamente -->
                </div>
            </section>
        </div>

        <!-- TAB: XTRA PADS (Independientes / Free) -->
        <div id="tab-xtra-pads" class="tab-content">
            <section class="pads-xtra-section" id="section-pads-xtra">
                <div class="pads-xtra-header">
                    <h2>XTRA PADS</h2>
                    <span class="free-badge">üé≤ FREE</span>
                    <p class="xtra-description">Pads independientes del sequencer. Sube tus propios WAV o selecciona de la librer√≠a.</p>
                </div>
                <div class="pads-xtra-grid" id="padsXtraGrid">
                    <!-- El primer pad "+" se genera en JS -->
                </div>
                
                <!-- XTRA Pads Filter Section -->
                <div class="xtra-filters-section">
                    <h3>üéõÔ∏è FILTROS XTRA PADS</h3>
                    <p class="xtra-filters-desc">Los filtros por pad (F) y efectos (FX) est√°n disponibles directamente en cada XTRA pad.</p>
                    <div class="xtra-filters-status" id="xtraFiltersStatus">
                        <span class="no-filters">A√±ade XTRA pads para aplicar filtros individuales</span>
                    </div>
                </div>
            </section>
        </div>

        <!-- TAB: Sequencer -->
        <div id="tab-sequencer" class="tab-content">
            <!-- Sequencer Section -->
            <section id="section-sequencer" class="sequencer-section" data-section="sequencer" data-title="Sequencer">
                <div class="sequencer-header">
                    <div class="sequencer-controls">
                        <button id="playBtn" class="seq-btn seq-btn-play" title="Play/Pause">
                            <span class="seq-btn-bg"></span>
                            <span class="seq-btn-icon">‚ñ∂</span>
                            <span class="seq-btn-label">PLAY</span>
                        </button>
                        <button id="stopBtn" class="seq-btn seq-btn-stop" title="Stop">
                            <span class="seq-btn-bg"></span>
                            <span class="seq-btn-icon">‚¨õ</span>
                            <span class="seq-btn-label">STOP</span>
                        </button>
                        <button id="clearBtn" class="seq-btn seq-btn-clear" title="Clear Pattern">
                            <span class="seq-btn-bg"></span>
                            <span class="seq-btn-icon">‚ö°</span>
                            <span class="seq-btn-label">CLEAR</span>
                        </button>
                        <button id="viewModeBtn" class="seq-btn seq-btn-view-mode" title="Cambiar vista: Grid / Circular">
                            <span class="seq-btn-bg"></span>
                            <span class="seq-btn-icon">‚≠ò</span>
                            <span class="seq-btn-label">CIRCULAR</span>
                        </button>
                        <button id="midiImportBtn" class="seq-btn seq-btn-midi-import" title="Importar archivo MIDI" onclick="showMidiImportDialog()">
                            <span class="seq-btn-bg"></span>
                            <span class="seq-btn-icon">üìÇ</span>
                            <span class="seq-btn-label">MIDI</span>
                        </button>
                        <button id="aiToggleBtn" class="seq-btn seq-btn-ai-toggle" title="Activar/Desactivar AI Chat">
                            <span class="seq-btn-bg"></span>
                            <span class="seq-btn-icon">ü§ñ</span>
                            <span class="seq-btn-label">AI OFF</span>
                        </button>
                        <span class="sync-badge">üîó SYNCED</span>
                        <div class="pattern-display">
                            <span class="pattern-label">PATTERN</span>
                            <span id="currentPatternName" class="pattern-name">HIP HOP</span>
                        </div>
                    </div>
                </div>
                
                <div class="sequencer-grid-wrapper" id="sequencerContainer">
                    <!-- Song Mode Bar Navigator -->
                    <div class="song-bar-navigator" id="songBarNavigator" style="display:none">
                        <div class="song-nav-header">
                            <span class="song-nav-icon">üéµ</span>
                            <span class="song-nav-title">SONG MODE</span>
                            <span class="song-nav-filename" id="songMidiFilename"></span>
                            <span class="song-nav-bar" id="songCurrentBar">Bar 1/1</span>
                            <button class="song-nav-exit" id="songModeExitBtn" title="Desactivar Song Mode">‚úï</button>
                        </div>
                        <div class="song-bar-buttons" id="songBarButtons">
                            <!-- Bar buttons generated dynamically -->
                        </div>
                    </div>
                    
                    <div class="sequencer-grid" id="sequencerGrid">
                        <!-- 8 tracks x 16 steps -->
                    </div>
                    
                    <div class="step-indicator" id="stepIndicator">
                        <!-- Indicador de step actual -->
                    </div>
                </div>
                
                <div class="sequencer-circular-wrapper hidden" id="sequencerCircularContainer">
                    <div class="circular-sequencer" id="circularSequencer">
                        <canvas id="circularCanvas"></canvas>
                        <div class="circular-center-display">
                            <div class="circular-step-number" id="circularStepNumber">1</div>
                            <div class="circular-pattern-name" id="circularPatternName">HIP HOP</div>
                        </div>
                        <div class="circular-track-labels" id="circularTrackLabels">
                            <!-- Track labels din√°micos -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- AI Chat Panel (inline in sequencer) - hidden by default -->
            <div class="seq-chat-panel ai-disabled" id="seqChatPanel">
                <div class="seq-chat-header" id="seqChatToggle">
                    <div class="seq-chat-header-left">
                        <span class="seq-chat-icon">ü§ñ</span>
                        <span class="seq-chat-title">AI CHAT</span>
                        <span class="seq-chat-status" id="seqChatStatus">‚óè</span>
                        <span class="chat-status-badge" id="chatStatusBadge" style="font-size:0.65em;padding:2px 8px">
                            <span class="chat-status-dot" id="chatStatusDot"></span>
                            <span id="chatStatusText">Offline</span>
                        </span>
                    </div>
                    <div class="seq-chat-header-right">
                        <input type="text" id="chatServerUrl" class="seq-chat-server-input" 
                               placeholder="http://192.168.1.133:3808" 
                               value="http://192.168.1.133:3808"
                               onclick="event.stopPropagation()">
                        <button class="seq-chat-connect-btn" id="chatConnectBtn" onclick="event.stopPropagation();chatConnect()" title="Conectar al servidor AI">CONECTAR</button>
                        <button class="seq-chat-action-btn" onclick="event.stopPropagation();chatResetSession()" title="Reset sesi√≥n">üîÑ</button>
                        <span class="seq-chat-badge" id="seqChatBadge" style="display:none">0</span>
                        <button class="seq-chat-expand-btn" id="seqChatExpandBtn" title="Expandir/colapsar">‚ñº</button>
                    </div>
                </div>
                <div class="seq-chat-body" id="seqChatBody">
                    <div class="seq-chat-feed" id="seqChatFeed">
                        <div class="seq-chat-hint">
                            <div style="font-size:1.8em;margin-bottom:6px">ü•Å</div>
                            <div><strong>RED808 AI Agent</strong></div>
                            <div style="margin:4px 0 10px;opacity:0.6">63 tools ¬∑ 23 instrumentos ¬∑ patr√≥n, FX, mixer, song</div>
                            <div class="seq-chat-suggestions">
                                <button class="seq-chat-sug" onclick="event.stopPropagation();seqSuggestion(this)">üéµ Beat de trap 140 BPM</button>
                                <button class="seq-chat-sug" onclick="event.stopPropagation();seqSuggestion(this)">üè† House minimalista</button>
                                <button class="seq-chat-sug" onclick="event.stopPropagation();seqSuggestion(this)">ü•Å Breakbeat Amen</button>
                                <button class="seq-chat-sug" onclick="event.stopPropagation();seqSuggestion(this)">üëª Ghost notes al hi-hat</button>
                                <button class="seq-chat-sug" onclick="event.stopPropagation();seqSuggestion(this)">ü§≤ Humaniza el patr√≥n</button>
                                <button class="seq-chat-sug" onclick="event.stopPropagation();seqSuggestion(this)">üé∂ Drum & bass 174 BPM</button>
                            </div>
                        </div>
                    </div>
                    <div class="seq-chat-input-row">
                        <textarea id="seqChatInput" class="seq-chat-input" placeholder="Escribe un mensaje para la IA..." rows="1"
                            onkeydown="seqChatKeydown(event)" oninput="seqChatAutoResize(this)"></textarea>
                        <button class="seq-chat-send" id="seqChatSendBtn" onclick="seqChatSend()" disabled>‚û§</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Controls (hidden, kept for JS compat) -->
        <div id="tab-controls" class="tab-content" style="display:none!important">
            <section id="section-controls" class="controls-section">
                <button id="colorToggle" class="btn-color-toggle" style="display:none">üé® COLOR MODE</button>
            </section>
        </div>

        <!-- TAB: Volumes -->
        <div id="tab-volumes" class="tab-content">
            <!-- Volumes Section -->
            <section id="section-volumes" class="volumes-section" data-section="volumes" data-title="Controles de Volumen">
                <div class="volumes-header">
                    <h2>üéöÔ∏è CONTROLES DE VOLUMEN</h2>
                    <p class="volumes-description">Control individual de vol√∫menes en tiempo real</p>
                    <div class="vol-layout-selector">
                        <span class="layout-sel-label">COLS</span>
                        <button class="vls-btn" data-cols="4">4</button>
                        <button class="vls-btn" data-cols="8">8</button>
                        <button class="vls-btn active" data-cols="16">16</button>
                    </div>
                </div>

                <!-- Master Volumes -->
                <div class="master-volumes">
                    <div class="volume-card sequencer-volume">
                        <div class="volume-card-header">
                            <span class="volume-icon">üéµ</span>
                            <h3>VOLUMEN SEQUENCER</h3>
                        </div>
                        <div class="volume-display">
                            <div class="volume-value-display" id="displaySequencerVolume">100%</div>
                            <div class="volume-bar-container">
                                <div class="volume-bar sequencer" id="barSequencerVolume" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="volume-card pads-volume">
                        <div class="volume-card-header">
                            <span class="volume-icon">üéπ</span>
                            <h3>VOLUMEN PADS</h3>
                        </div>
                        <div class="volume-display">
                            <div class="volume-value-display" id="displayPadsVolume">100%</div>
                            <div class="volume-bar-container">
                                <div class="volume-bar pads" id="barPadsVolume" style="width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Track Volumes -->
                <div class="track-volumes">
                    <h3 class="track-volumes-title">VOLUMENES DE TRACKS</h3>
                    <div class="track-volumes-grid" id="trackVolumesGrid">
                        <!-- Track 0: BD -->
                        <div class="track-volume-card" data-track="0">
                            <div class="track-volume-header">
                                <span class="track-volume-label">BD</span>
                                <span class="track-volume-value" id="trackVolumeValue0">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator0"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar0" data-track="0" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 1: SD -->
                        <div class="track-volume-card" data-track="1">
                            <div class="track-volume-header">
                                <span class="track-volume-label">SD</span>
                                <span class="track-volume-value" id="trackVolumeValue1">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator1"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar1" data-track="1" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 2: CH -->
                        <div class="track-volume-card" data-track="2">
                            <div class="track-volume-header">
                                <span class="track-volume-label">CH</span>
                                <span class="track-volume-value" id="trackVolumeValue2">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator2"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar2" data-track="2" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 3: OH -->
                        <div class="track-volume-card" data-track="3">
                            <div class="track-volume-header">
                                <span class="track-volume-label">OH</span>
                                <span class="track-volume-value" id="trackVolumeValue3">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator3"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar3" data-track="3" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 4: CP -->
                        <div class="track-volume-card" data-track="4">
                            <div class="track-volume-header">
                                <span class="track-volume-label">CP</span>
                                <span class="track-volume-value" id="trackVolumeValue4">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator4"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar4" data-track="4" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 5: RS -->
                        <div class="track-volume-card" data-track="5">
                            <div class="track-volume-header">
                                <span class="track-volume-label">RS</span>
                                <span class="track-volume-value" id="trackVolumeValue5">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator5"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar5" data-track="5" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 6: CL -->
                        <div class="track-volume-card" data-track="6">
                            <div class="track-volume-header">
                                <span class="track-volume-label">CL</span>
                                <span class="track-volume-value" id="trackVolumeValue6">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator6"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar6" data-track="6" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 7: CY -->
                        <div class="track-volume-card" data-track="7">
                            <div class="track-volume-header">
                                <span class="track-volume-label">CY</span>
                                <span class="track-volume-value" id="trackVolumeValue7">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator7"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar7" data-track="7" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 8: LT -->
                        <div class="track-volume-card" data-track="8">
                            <div class="track-volume-header">
                                <span class="track-volume-label">LT</span>
                                <span class="track-volume-value" id="trackVolumeValue8">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator8"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar8" data-track="8" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 9: MT -->
                        <div class="track-volume-card" data-track="9">
                            <div class="track-volume-header">
                                <span class="track-volume-label">MT</span>
                                <span class="track-volume-value" id="trackVolumeValue9">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator9"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar9" data-track="9" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 10: HT -->
                        <div class="track-volume-card" data-track="10">
                            <div class="track-volume-header">
                                <span class="track-volume-label">HT</span>
                                <span class="track-volume-value" id="trackVolumeValue10">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator10"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar10" data-track="10" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 11: MA -->
                        <div class="track-volume-card" data-track="11">
                            <div class="track-volume-header">
                                <span class="track-volume-label">MA</span>
                                <span class="track-volume-value" id="trackVolumeValue11">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator11"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar11" data-track="11" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 12: CB -->
                        <div class="track-volume-card" data-track="12">
                            <div class="track-volume-header">
                                <span class="track-volume-label">CB</span>
                                <span class="track-volume-value" id="trackVolumeValue12">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator12"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar12" data-track="12" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 13: HC -->
                        <div class="track-volume-card" data-track="13">
                            <div class="track-volume-header">
                                <span class="track-volume-label">HC</span>
                                <span class="track-volume-value" id="trackVolumeValue13">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator13"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar13" data-track="13" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 14: MC -->
                        <div class="track-volume-card" data-track="14">
                            <div class="track-volume-header">
                                <span class="track-volume-label">MC</span>
                                <span class="track-volume-value" id="trackVolumeValue14">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator14"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar14" data-track="14" style="height: 100%;"></div>
                            </div>
                        </div>
                        <!-- Track 15: LC -->
                        <div class="track-volume-card" data-track="15">
                            <div class="track-volume-header">
                                <span class="track-volume-label">LC</span>
                                <span class="track-volume-value" id="trackVolumeValue15">100%</span>
                                <span class="track-volume-mute-indicator" id="trackMuteIndicator15"></span>
                            </div>
                            <div class="track-volume-bar-container">
                                <div class="track-volume-bar" id="trackVolumeBar15" data-track="15" style="height: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- TAB: FX -->
        <div id="tab-fx" class="tab-content">
            <!-- FX Section -->
            <section id="section-fx" class="fx-section" data-section="fx" data-title="Sound FX">
                <h2>üéõÔ∏è FILTROS & EFECTOS</h2>
                
                <!-- Sub-tab navigation for FILTERS / FX -->
                <div class="fx-subtabs">
                    <button class="fx-subtab-btn active" data-fxtab="filters">üéöÔ∏è FILTERS</button>
                    <button class="fx-subtab-btn" data-fxtab="masterFx">üé∏ FX</button>
                </div>
                
                <!-- SUB-TAB: Filters -->
                <div class="fx-subtab-content active" id="fxtab-filters">
                <!-- Filter Library with presets -->
                <div class="filter-library">
                    <h3>üìö BIBLIOTECA DE FILTROS</h3>
                    <p class="filter-description">Selecciona un track o pad primero, luego aplica un filtro. ¬°Los presets tienen valores optimizados para que se noten!</p>
                    
                    <div class="filters-grid">
                        <!-- 0: NONE -->
                        <div class="filter-card filter-card-none" data-filter="0">
                            <div class="filter-header">
                                <span class="filter-icon">üö´</span>
                                <span class="filter-title">OFF</span>
                                <span class="filter-key">F1</span>
                            </div>
                            <p class="filter-desc">Quitar filtro. Restaura sonido original.</p>
                        </div>
                        
                        <!-- 1: LOW PASS -->
                        <div class="filter-card filter-card-warm" data-filter="1">
                            <div class="filter-header">
                                <span class="filter-icon">üî•</span>
                                <span class="filter-title">LOW PASS</span>
                                <span class="filter-key">F2</span>
                            </div>
                            <p class="filter-desc">Quita agudos. Sonido oscuro, profundo, tipo DJ.</p>
                        </div>
                        
                        <!-- 2: HIGH PASS -->
                        <div class="filter-card filter-card-bright" data-filter="2">
                            <div class="filter-header">
                                <span class="filter-icon">‚ú®</span>
                                <span class="filter-title">HIGH PASS</span>
                                <span class="filter-key">F3</span>
                            </div>
                            <p class="filter-desc">Quita graves. Sonido fino, a√©reo.</p>
                        </div>
                        
                        <!-- 9: RESONANT -->
                        <div class="filter-card filter-card-acid" data-filter="9">
                            <div class="filter-header">
                                <span class="filter-icon">‚ö°</span>
                                <span class="filter-title">RESONANT</span>
                                <span class="filter-key">F10</span>
                            </div>
                            <p class="filter-desc">Filtro √°cido tipo TB-303. Resonancia extrema.</p>
                        </div>
                        
                        <!-- 3: BAND PASS -->
                        <div class="filter-card filter-card-creative" data-filter="3">
                            <div class="filter-header">
                                <span class="filter-icon">üìû</span>
                                <span class="filter-title">BAND PASS</span>
                                <span class="filter-key">F4</span>
                            </div>
                            <p class="filter-desc">Solo un rango pasa. Efecto tel√©fono, lo-fi.</p>
                        </div>
                        
                        <!-- 7: PEAKING EQ -->
                        <div class="filter-card filter-card-boost" data-filter="7">
                            <div class="filter-header">
                                <span class="filter-icon">‚õ∞Ô∏è</span>
                                <span class="filter-title">PEAK BOOST</span>
                                <span class="filter-key">F8</span>
                            </div>
                            <p class="filter-desc">Realza una frecuencia. Da punch o brillo.</p>
                        </div>
                        
                        <!-- 4: NOTCH -->
                        <div class="filter-card filter-card-cut" data-filter="4">
                            <div class="filter-header">
                                <span class="filter-icon">üï≥Ô∏è</span>
                                <span class="filter-title">NOTCH CUT</span>
                                <span class="filter-key">F5</span>
                            </div>
                            <p class="filter-desc">Elimina una frecuencia. Efecto phaser.</p>
                        </div>
                        
                        <!-- 5: LOW SHELF -->
                        <div class="filter-card filter-card-boost" data-filter="5">
                            <div class="filter-header">
                                <span class="filter-icon">üîä</span>
                                <span class="filter-title">BASS BOOST</span>
                                <span class="filter-key">F6</span>
                            </div>
                            <p class="filter-desc">Sube los graves. M√°s pegada en bombo.</p>
                        </div>
                        
                        <!-- 6: HIGH SHELF -->
                        <div class="filter-card filter-card-bright" data-filter="6">
                            <div class="filter-header">
                                <span class="filter-icon">üåü</span>
                                <span class="filter-title">TREBLE BOOST</span>
                                <span class="filter-key">F7</span>
                            </div>
                            <p class="filter-desc">Sube los agudos. M√°s brillo y presencia.</p>
                        </div>
                        
                        <!-- 8: ALL PASS -->
                        <div class="filter-card filter-card-creative" data-filter="8">
                            <div class="filter-header">
                                <span class="filter-icon">üåÄ</span>
                                <span class="filter-title">PHASE</span>
                                <span class="filter-key">F9</span>
                            </div>
                            <p class="filter-desc">Cambia la fase. Efecto phaser sutil.</p>
                        </div>
                        

                    </div>
                </div>
                </div><!-- end fxtab-filters -->
                
                <!-- SUB-TAB: Master FX -->
                <div class="fx-subtab-content" id="fxtab-masterFx">
                
                <!-- ============= TRACK FX Section ============= -->
                <div class="track-fx-section">
                    <h3>üéõÔ∏è TRACK FX <span class="fx-subtitle">Combinables en tiempo real</span></h3>
                    <p class="track-fx-desc">Selecciona un track y activa/desactiva efectos. Se pueden combinar varios FX simult√°neamente.</p>
                    
                    <!-- Track Selector -->
                    <div class="track-fx-selector" id="trackFxSelector">
                        <button class="track-fx-btn active" data-track="0">BD</button>
                        <button class="track-fx-btn" data-track="1">SD</button>
                        <button class="track-fx-btn" data-track="2">CH</button>
                        <button class="track-fx-btn" data-track="3">OH</button>
                        <button class="track-fx-btn" data-track="4">CY</button>
                        <button class="track-fx-btn" data-track="5">CP</button>
                        <button class="track-fx-btn" data-track="6">RS</button>
                        <button class="track-fx-btn" data-track="7">CB</button>
                        <button class="track-fx-btn" data-track="8">LT</button>
                        <button class="track-fx-btn" data-track="9">MT</button>
                        <button class="track-fx-btn" data-track="10">HT</button>
                        <button class="track-fx-btn" data-track="11">MA</button>
                        <button class="track-fx-btn" data-track="12">CL</button>
                        <button class="track-fx-btn" data-track="13">HC</button>
                        <button class="track-fx-btn" data-track="14">MC</button>
                        <button class="track-fx-btn" data-track="15">LC</button>
                    </div>
                    
                    <!-- FX Toggle Cards -->
                    <div class="track-fx-cards">
                        <!-- REVERSE -->
                        <div class="track-fx-card" id="fxCardReverse">
                            <div class="track-fx-card-header">
                                <span class="track-fx-icon">‚è™</span>
                                <span class="track-fx-name">REVERSE</span>
                                <label class="fx-toggle">
                                    <input type="checkbox" id="fxReverseToggle" onchange="toggleTrackFx('reverse', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="track-fx-card-desc">Invierte el sample. Reproduce al rev√©s para buildups y efectos creativos.</p>
                        </div>
                        
                        <!-- PITCH SHIFT -->
                        <div class="track-fx-card" id="fxCardPitch">
                            <div class="track-fx-card-header">
                                <span class="track-fx-icon">üéµ</span>
                                <span class="track-fx-name">PITCH SHIFT</span>
                                <label class="fx-toggle">
                                    <input type="checkbox" id="fxPitchToggle" onchange="toggleTrackFx('pitch', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="track-fx-card-desc">Cambia la velocidad/tono del sample.</p>
                            <div class="track-fx-controls">
                                <div class="pitch-presets">
                                    <button class="pitch-preset-btn" onclick="setTrackFxPitch(0.25)">¬º√ó</button>
                                    <button class="pitch-preset-btn" onclick="setTrackFxPitch(0.5)">¬Ω√ó</button>
                                    <button class="pitch-preset-btn" onclick="setTrackFxPitch(0.75)">¬æ√ó</button>
                                    <button class="pitch-preset-btn active" onclick="setTrackFxPitch(1.0)">1√ó</button>
                                    <button class="pitch-preset-btn" onclick="setTrackFxPitch(1.5)">1.5√ó</button>
                                    <button class="pitch-preset-btn" onclick="setTrackFxPitch(2.0)">2√ó</button>
                                    <button class="pitch-preset-btn" onclick="setTrackFxPitch(3.0)">3√ó</button>
                                </div>
                                <div class="fx-control">
                                    <label>Speed <span id="fxPitchValue">1.00</span>√ó</label>
                                    <input type="range" id="fxPitchSlider" min="25" max="400" value="100" class="fx-slider" oninput="setTrackFxPitch(this.value/100)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- STUTTER -->
                        <div class="track-fx-card" id="fxCardStutter">
                            <div class="track-fx-card-header">
                                <span class="track-fx-icon">üîÅ</span>
                                <span class="track-fx-name">STUTTER</span>
                                <label class="fx-toggle">
                                    <input type="checkbox" id="fxStutterToggle" onchange="toggleTrackFx('stutter', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p class="track-fx-card-desc">Repite r√°pidamente el inicio del sample. Efecto glitch/IDM.</p>
                            <div class="track-fx-controls">
                                <div class="pitch-presets">
                                    <button class="pitch-preset-btn" onclick="setTrackFxStutter(30)">30ms</button>
                                    <button class="pitch-preset-btn" onclick="setTrackFxStutter(50)">50ms</button>
                                    <button class="pitch-preset-btn active" onclick="setTrackFxStutter(100)">100ms</button>
                                    <button class="pitch-preset-btn" onclick="setTrackFxStutter(150)">150ms</button>
                                    <button class="pitch-preset-btn" onclick="setTrackFxStutter(200)">200ms</button>
                                </div>
                                <div class="fx-control">
                                    <label>Interval <span id="fxStutterValue">100</span>ms</label>
                                    <input type="range" id="fxStutterSlider" min="10" max="500" value="100" class="fx-slider" oninput="setTrackFxStutter(parseInt(this.value))">
                                </div>
                            </div>
                        </div>
                        

                    </div>
                    
                    <!-- Active FX Status Grid -->
                    <div class="track-fx-status" id="trackFxStatus">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <!-- ============= MASTER EFFECTS Section ============= -->
                <div class="master-fx-section">
                    <h3>üéöÔ∏è MASTER EFFECTS <span class="fx-subtitle">(inspired by torvalds/AudioNoise)</span></h3>
                    
                    <!-- Distortion (improved with modes) -->
                    <div class="fx-card fx-card-distortion">
                        <div class="fx-header">
                            <span class="fx-icon">üé∏</span>
                            <span class="fx-title">DISTORTION</span>
                        </div>
                        <div class="fx-controls">
                            <div class="fx-control">
                                <label>Mode</label>
                                <select id="distortionMode" class="fx-select">
                                    <option value="0" selected>Soft Clip</option>
                                    <option value="1">Hard Clip</option>
                                    <option value="2">Tube</option>
                                    <option value="3">Fuzz</option>
                                </select>
                            </div>
                            <div class="fx-control">
                                <label>Drive <span id="distortionValue">0</span>%</label>
                                <input type="range" id="distortion" min="0" max="100" value="0" class="fx-slider">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delay/Echo -->
                    <div class="fx-card fx-card-delay">
                        <div class="fx-header">
                            <span class="fx-icon">üîä</span>
                            <span class="fx-title">DELAY / ECHO</span>
                            <label class="fx-toggle">
                                <input type="checkbox" id="delayActive">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="fx-controls">
                            <div class="fx-control">
                                <label>Time <span id="delayTimeValue">250</span>ms</label>
                                <input type="range" id="delayTime" min="10" max="750" value="250" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Feedback <span id="delayFeedbackValue">30</span>%</label>
                                <input type="range" id="delayFeedback" min="0" max="95" value="30" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Mix <span id="delayMixValue">30</span>%</label>
                                <input type="range" id="delayMix" min="0" max="100" value="30" class="fx-slider">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phaser -->
                    <div class="fx-card fx-card-phaser">
                        <div class="fx-header">
                            <span class="fx-icon">üåÄ</span>
                            <span class="fx-title">PHASER</span>
                            <label class="fx-toggle">
                                <input type="checkbox" id="phaserActive">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="fx-controls">
                            <div class="fx-control">
                                <label>Rate <span id="phaserRateValue">50</span></label>
                                <input type="range" id="phaserRate" min="5" max="500" value="50" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Depth <span id="phaserDepthValue">70</span>%</label>
                                <input type="range" id="phaserDepth" min="0" max="100" value="70" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Feedback <span id="phaserFeedbackValue">30</span>%</label>
                                <input type="range" id="phaserFeedback" min="-90" max="90" value="30" class="fx-slider">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Flanger -->
                    <div class="fx-card fx-card-flanger">
                        <div class="fx-header">
                            <span class="fx-icon">üåä</span>
                            <span class="fx-title">FLANGER</span>
                            <label class="fx-toggle">
                                <input type="checkbox" id="flangerActive">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="fx-controls">
                            <div class="fx-control">
                                <label>Rate <span id="flangerRateValue">30</span></label>
                                <input type="range" id="flangerRate" min="5" max="500" value="30" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Depth <span id="flangerDepthValue">50</span>%</label>
                                <input type="range" id="flangerDepth" min="0" max="100" value="50" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Feedback <span id="flangerFeedbackValue">40</span>%</label>
                                <input type="range" id="flangerFeedback" min="-90" max="90" value="40" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Mix <span id="flangerMixValue">50</span>%</label>
                                <input type="range" id="flangerMix" min="0" max="100" value="50" class="fx-slider">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compressor/Limiter -->
                    <div class="fx-card fx-card-compressor">
                        <div class="fx-header">
                            <span class="fx-icon">üìä</span>
                            <span class="fx-title">COMPRESSOR</span>
                            <label class="fx-toggle">
                                <input type="checkbox" id="compressorActive">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="fx-controls">
                            <div class="fx-control">
                                <label>Threshold <span id="compressorThresholdValue">-12</span>dB</label>
                                <input type="range" id="compressorThreshold" min="-60" max="0" value="-12" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Ratio <span id="compressorRatioValue">4</span>:1</label>
                                <input type="range" id="compressorRatio" min="1" max="20" value="4" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Attack <span id="compressorAttackValue">10</span>ms</label>
                                <input type="range" id="compressorAttack" min="1" max="100" value="10" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Release <span id="compressorReleaseValue">100</span>ms</label>
                                <input type="range" id="compressorRelease" min="10" max="1000" value="100" step="10" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Makeup <span id="compressorMakeupValue">0</span>dB</label>
                                <input type="range" id="compressorMakeup" min="0" max="24" value="0" class="fx-slider">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lo-Fi Section -->
                    <div class="fx-card fx-card-lofi">
                        <div class="fx-header">
                            <span class="fx-icon">üìº</span>
                            <span class="fx-title">LO-FI</span>
                            <label class="fx-toggle">
                                <input type="checkbox" id="lofiActive">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="fx-controls">
                            <div class="fx-control">
                                <label>Bit Crush <span id="bitCrushValue">16</span> bits</label>
                                <input type="range" id="bitCrush" min="4" max="16" value="16" class="fx-slider">
                            </div>
                            <div class="fx-control">
                                <label>Sample Rate <span id="sampleRateValue">44100</span> Hz</label>
                                <input type="range" id="sampleRate" min="8000" max="44100" value="44100" step="100" class="fx-slider">
                            </div>
                        </div>
                    </div>
                </div>
                </div><!-- end fxtab-masterFx -->
                
                <!-- Active Filters Display -->
                <div class="active-filters-section">
                    <h3>‚ú® FILTROS ACTIVOS</h3>
                    <div class="active-filters-display">
                        <div class="active-filter-group">
                            <h4>üéµ TRACKS (F1-F10)</h4>
                            <div id="activeTrackFilters" class="active-filter-list">
                                <span class="no-filters">Ning√∫n filtro aplicado a tracks</span>
                            </div>
                        </div>
                        <div class="active-filter-group">
                            <h4>üéπ PADS (Shift+F1-F10)</h4>
                            <div id="activePadFilters" class="active-filter-list">
                                <span class="no-filters">Ning√∫n filtro aplicado a pads</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Reference -->
                <div class="filter-reference">
                    <h4>‚å®Ô∏è GU√çA R√ÅPIDA</h4>
                    <div class="reference-grid">
                        <div class="reference-item">
                            <strong>Filtro a Track:</strong>
                            <p>1. Click en nombre track (BD, SD, etc.)<br>2. Presiona F1-F10</p>
                        </div>
                        <div class="reference-item">
                            <strong>Filtro a Pad:</strong>
                            <p>1. Click en pad en secci√≥n LIVE<br>2. Presiona Shift+F1-F10</p>
                        </div>
                        <div class="reference-item">
                            <strong>Presets R√°pidos:</strong>
                            <p>Click en botones de presets<br>para aplicar frecuencias t√≠picas</p>
                        </div>
                        <div class="reference-item">
                            <strong>Ver Activos:</strong>
                            <p>Los filtros activos se muestran<br>con badges en pads y tracks</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- TAB: MIDI -->
        <div id="tab-midi" class="tab-content">
            <section id="section-midi" class="midi-section" data-section="midi" data-title="MIDI Control">
                
                <!-- MIDI Dashboard Header -->
                <div class="midi-dashboard-header">
                    <div class="midi-title-group">
                        <h2>üéπ MIDI USB DASHBOARD</h2>
                        <div class="midi-connection-badge" id="midiConnectionBadge">
                            <span class="badge-dot"></span>
                            <span class="badge-text">Desconectado</span>
                        </div>
                    </div>
                    <div class="midi-scan-toggle">
                        <label class="toggle-switch" title="Activar/desactivar escaneo de dispositivos MIDI USB">
                            <input type="checkbox" id="midiScanToggle" onchange="toggleMidiScan(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="midi-scan-label">USB Scan</span>
                    </div>
                </div>

                <!-- Stats Overview -->
                <div class="midi-stats-row">
                    <div class="stat-card">
                        <div class="stat-icon">üéµ</div>
                        <div class="stat-content">
                            <div class="stat-value" id="midiTotalNotes">0</div>
                            <div class="stat-label">Notas MIDI</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ö°</div>
                        <div class="stat-content">
                            <div class="stat-value" id="midiAvgVelocity">‚Äî</div>
                            <div class="stat-label">Velocity Media</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéõÔ∏è</div>
                        <div class="stat-content">
                            <div class="stat-value" id="midiCCMessages">0</div>
                            <div class="stat-label">CC Messages</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <div class="stat-content">
                            <div class="stat-value" id="midiUptime">00:00</div>
                            <div class="stat-label">Tiempo Activo</div>
                        </div>
                    </div>
                </div>

                <!-- Main Dashboard Grid -->
                <div class="midi-dashboard-grid">
                    
                    <!-- Left Column: Device Info & Mapping -->
                    <div class="midi-left-column">
                        
                        <!-- Device Info Card -->
                        <div class="dashboard-card device-info-card" id="midiDeviceCard">
                            <div class="card-header">
                                <h3><span class="card-icon">üîå</span> Dispositivo Conectado</h3>
                                <div class="signal-indicator">
                                    <span class="signal-bar"></span>
                                    <span class="signal-bar"></span>
                                    <span class="signal-bar"></span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="device-detail">
                                    <span class="detail-label">Dispositivo:</span>
                                    <span class="detail-value" id="midiDeviceName">Esperando conexi√≥n...</span>
                                </div>
                                <div class="device-detail">
                                    <span class="detail-label">Vendor ID:</span>
                                    <span class="detail-value" id="midiVendorId">‚Äî</span>
                                </div>
                                <div class="device-detail">
                                    <span class="detail-label">Product ID:</span>
                                    <span class="detail-value" id="midiProductId">‚Äî</span>
                                </div>
                                <div class="device-detail">
                                    <span class="detail-label">Puerto USB:</span>
                                    <span class="detail-value">OTG (GPIO 19/20)</span>
                                </div>
                            </div>
                        </div>

                        <!-- MIDI Note Mapping Card -->
                        <div class="dashboard-card mapping-card">
                            <div class="card-header">
                                <h3><span class="card-icon">üó∫Ô∏è</span> Note Mapping</h3>
                                <div class="mapping-controls">
                                    <button class="mapping-btn" id="editMappingBtn" onclick="toggleMappingEdit()">‚úèÔ∏è Editar</button>
                                    <button class="mapping-btn secondary" id="resetMappingBtn" onclick="resetMIDIMapping()" style="display:none;">üîÑ Reset GM</button>
                                    <button class="mapping-btn primary" id="saveMappingBtn" onclick="saveMIDIMapping()" style="display:none;">üíæ Guardar</button>
                                    <button class="mapping-btn" id="cancelMappingBtn" onclick="cancelMappingEdit()" style="display:none;">‚úñ Cancelar</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Preset selector (visible en modo edici√≥n) -->
                                <div class="mapping-presets" id="mappingPresets" style="display:none;">
                                    <span class="preset-label">Presets:</span>
                                    <button class="preset-btn" onclick="applyMappingPreset('gm')">üéº GM</button>
                                    <button class="preset-btn" onclick="applyMappingPreset('roland')">ü•Å Roland</button>
                                    <button class="preset-btn" onclick="applyMappingPreset('mpc')">‚¨õ MPC</button>
                                    <button class="preset-btn" onclick="applyMappingPreset('custom')">‚öôÔ∏è Custom</button>
                                </div>
                                <!-- Mapping grid 16 pads -->
                                <div class="mapping-grid" id="mappingGrid">
                                    <!-- BD ‚Üí note 36 C1 -->
                                    <div class="mapping-item" data-pad="0" data-note="36">
                                        <span class="pad-color-dot" style="background:rgb(255,0,0)"></span>
                                        <span class="pad-target">BD</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="36" disabled>
                                            <span class="note-value">36</span>
                                            <span class="note-name">C1</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- SD ‚Üí 38 D1 -->
                                    <div class="mapping-item" data-pad="1" data-note="38">
                                        <span class="pad-color-dot" style="background:rgb(255,165,0)"></span>
                                        <span class="pad-target">SD</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="38" disabled>
                                            <span class="note-value">38</span>
                                            <span class="note-name">D1</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- CH ‚Üí 42 F#1 -->
                                    <div class="mapping-item" data-pad="2" data-note="42">
                                        <span class="pad-color-dot" style="background:rgb(255,255,0)"></span>
                                        <span class="pad-target">CH</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="42" disabled>
                                            <span class="note-value">42</span>
                                            <span class="note-name">F#1</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- OH ‚Üí 46 A#1 -->
                                    <div class="mapping-item" data-pad="3" data-note="46">
                                        <span class="pad-color-dot" style="background:rgb(0,255,255)"></span>
                                        <span class="pad-target">OH</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="46" disabled>
                                            <span class="note-value">46</span>
                                            <span class="note-name">A#1</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- CY ‚Üí 49 C#2 -->
                                    <div class="mapping-item" data-pad="4" data-note="49">
                                        <span class="pad-color-dot" style="background:rgb(230,25,75)"></span>
                                        <span class="pad-target">CY</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="49" disabled>
                                            <span class="note-value">49</span>
                                            <span class="note-name">C#2</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- CP ‚Üí 39 D#1 -->
                                    <div class="mapping-item" data-pad="5" data-note="39">
                                        <span class="pad-color-dot" style="background:rgb(255,0,255)"></span>
                                        <span class="pad-target">CP</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="39" disabled>
                                            <span class="note-value">39</span>
                                            <span class="note-name">D#1</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- RS ‚Üí 37 C#1 -->
                                    <div class="mapping-item" data-pad="6" data-note="37">
                                        <span class="pad-color-dot" style="background:rgb(0,255,0)"></span>
                                        <span class="pad-target">RS</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="37" disabled>
                                            <span class="note-value">37</span>
                                            <span class="note-name">C#1</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- CB ‚Üí 56 G#2 -->
                                    <div class="mapping-item" data-pad="7" data-note="56">
                                        <span class="pad-color-dot" style="background:rgb(245,130,49)"></span>
                                        <span class="pad-target">CB</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="56" disabled>
                                            <span class="note-value">56</span>
                                            <span class="note-name">G#2</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- LT ‚Üí 41 F1 -->
                                    <div class="mapping-item" data-pad="8" data-note="41">
                                        <span class="pad-color-dot" style="background:rgb(145,30,180)"></span>
                                        <span class="pad-target">LT</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="41" disabled>
                                            <span class="note-value">41</span>
                                            <span class="note-name">F1</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- MT ‚Üí 47 B1 -->
                                    <div class="mapping-item" data-pad="9" data-note="47">
                                        <span class="pad-color-dot" style="background:rgb(70,240,240)"></span>
                                        <span class="pad-target">MT</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="47" disabled>
                                            <span class="note-value">47</span>
                                            <span class="note-name">B1</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- HT ‚Üí 50 D2 -->
                                    <div class="mapping-item" data-pad="10" data-note="50">
                                        <span class="pad-color-dot" style="background:rgb(240,50,230)"></span>
                                        <span class="pad-target">HT</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="50" disabled>
                                            <span class="note-value">50</span>
                                            <span class="note-name">D2</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- MA ‚Üí 70 A#3 -->
                                    <div class="mapping-item" data-pad="11" data-note="70">
                                        <span class="pad-color-dot" style="background:rgb(188,246,12)"></span>
                                        <span class="pad-target">MA</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="70" disabled>
                                            <span class="note-value">70</span>
                                            <span class="note-name">A#3</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- CL ‚Üí 75 D#4 -->
                                    <div class="mapping-item" data-pad="12" data-note="75">
                                        <span class="pad-color-dot" style="background:rgb(56,206,255)"></span>
                                        <span class="pad-target">CL</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="75" disabled>
                                            <span class="note-value">75</span>
                                            <span class="note-name">D#4</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- HC ‚Üí 62 D3 -->
                                    <div class="mapping-item" data-pad="13" data-note="62">
                                        <span class="pad-color-dot" style="background:rgb(250,190,190)"></span>
                                        <span class="pad-target">HC</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="62" disabled>
                                            <span class="note-value">62</span>
                                            <span class="note-name">D3</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- MC ‚Üí 63 D#3 -->
                                    <div class="mapping-item" data-pad="14" data-note="63">
                                        <span class="pad-color-dot" style="background:rgb(0,128,128)"></span>
                                        <span class="pad-target">MC</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="63" disabled>
                                            <span class="note-value">63</span>
                                            <span class="note-name">D#3</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                    <!-- LC ‚Üí 64 E3 -->
                                    <div class="mapping-item" data-pad="15" data-note="64">
                                        <span class="pad-color-dot" style="background:rgb(72,77,255)"></span>
                                        <span class="pad-target">LC</span>
                                        <div class="note-input-group">
                                            <input class="note-input" type="range" min="0" max="127" value="64" disabled>
                                            <span class="note-value">64</span>
                                            <span class="note-name">E3</span>
                                        </div>
                                        <div class="velocity-bar"><div class="velocity-fill"></div></div>
                                    </div>
                                </div>
                                <!-- GM Reference table (always visible) -->
                                <details class="gm-reference">
                                    <summary>üìñ Referencia GM Drum Map</summary>
                                    <div class="gm-table">
                                        <div class="gm-row header"><span>Nota</span><span>Nombre GM</span><span>Pad</span></div>
                                        <div class="gm-row"><span>35</span><span>Acoustic Bass Drum</span><span>BD</span></div>
                                        <div class="gm-row"><span>36</span><span>Bass Drum 1</span><span>BD</span></div>
                                        <div class="gm-row"><span>37</span><span>Side Stick / Rimshot</span><span>RS</span></div>
                                        <div class="gm-row"><span>38</span><span>Acoustic Snare</span><span>SD</span></div>
                                        <div class="gm-row"><span>39</span><span>Hand Clap</span><span>CP</span></div>
                                        <div class="gm-row"><span>40</span><span>Electric Snare</span><span>SD</span></div>
                                        <div class="gm-row"><span>41</span><span>Low Floor Tom</span><span>LT</span></div>
                                        <div class="gm-row"><span>42</span><span>Closed Hi-Hat</span><span>CH</span></div>
                                        <div class="gm-row"><span>43</span><span>High Floor Tom</span><span>LT</span></div>
                                        <div class="gm-row"><span>44</span><span>Pedal Hi-Hat</span><span>CH</span></div>
                                        <div class="gm-row"><span>45</span><span>Low Tom</span><span>MT</span></div>
                                        <div class="gm-row"><span>46</span><span>Open Hi-Hat</span><span>OH</span></div>
                                        <div class="gm-row"><span>47</span><span>Low-Mid Tom</span><span>MT</span></div>
                                        <div class="gm-row"><span>48</span><span>Hi-Mid Tom</span><span>HT</span></div>
                                        <div class="gm-row"><span>49</span><span>Crash Cymbal 1</span><span>CY</span></div>
                                        <div class="gm-row"><span>50</span><span>High Tom</span><span>HT</span></div>
                                        <div class="gm-row"><span>51</span><span>Ride Cymbal 1</span><span>CY</span></div>
                                        <div class="gm-row"><span>56</span><span>Cowbell</span><span>CB</span></div>
                                        <div class="gm-row"><span>57</span><span>Crash Cymbal 2</span><span>CY</span></div>
                                        <div class="gm-row"><span>62</span><span>Mute Hi Conga</span><span>HC</span></div>
                                        <div class="gm-row"><span>63</span><span>Open Hi Conga</span><span>MC</span></div>
                                        <div class="gm-row"><span>64</span><span>Low Conga</span><span>LC</span></div>
                                        <div class="gm-row"><span>70</span><span>Maracas</span><span>MA</span></div>
                                        <div class="gm-row"><span>75</span><span>Claves</span><span>CL</span></div>
                                    </div>
                                </details>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Live Monitor -->
                    <div class="midi-right-column">
                        <div class="dashboard-card monitor-card">
                            <div class="card-header">
                                <h3><span class="card-icon">üì°</span> Monitor en Tiempo Real</h3>
                                <div class="monitor-filter-row">
                                    <select id="midiMonitorFilter" class="monitor-filter-select" onchange="setMidiMonitorFilter(this.value)">
                                        <option value="all">Todos</option>
                                        <option value="noteOn">Note On</option>
                                        <option value="noteOff">Note Off</option>
                                        <option value="cc">CC</option>
                                        <option value="pitchBend">Pitch Bend</option>
                                    </select>
                                    <button class="clear-monitor-btn" id="clearMidiMonitor">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="monitor-display" id="midiMonitor">
                                    <div class="monitor-placeholder">
                                        <div class="placeholder-icon">üéπ</div>
                                        <div class="placeholder-text">Esperando mensajes MIDI...</div>
                                        <div class="placeholder-hint">Conecta un dispositivo y toca algunas notas</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </section>
        </div>

        <!-- Hidden chat elements (needed by chat-agent.js) -->
        <div id="chatMessages" style="display:none"></div>
        <textarea id="chatInput" style="display:none"></textarea>
        <button id="chatSendBtn" style="display:none"></button>
        <div id="chatProgress" style="display:none"><div id="chatProgressFill"></div><span id="chatProgressText"></span></div>

        <!-- TAB: Info (Device + Instruments) -->
        <div id="tab-info" class="tab-content">
            <!-- Device Info Section -->
            <section id="section-device" class="device-info" data-section="device" data-title="Device Info">
                <div class="info-title">üéõÔ∏è DEVICE + LIBRARY</div>
                <div style="margin-bottom: 10px;">
                    <button id="reloadCountsBtn" class="btn" style="background: #00aa00; padding: 6px 12px; font-size: 0.9em;">üîÑ RECARGAR CONTEOS</button>
                </div>
                <div class="device-cards">
                    <div class="info-card emphasis">
                        <span class="info-label">Samples Loaded</span>
                        <span class="info-value" id="samplesCount">0</span>
                        <span class="info-sub" id="libraryTotals">0 files / 0 families</span>
                    </div>
                    <div class="info-card">
                        <span class="info-label">Memory Used</span>
                        <span class="info-value" id="memoryUsed">0 MB</span>
                        <span class="info-sub" id="psramFree">PSRAM free ‚Äî</span>
                    </div>
                    <div class="info-card">
                        <span class="info-label">Sample Format</span>
                        <span class="info-value" id="sampleFormat">44.1kHz Mono 16-bit</span>
                        <span class="info-sub">Renderer locked @ 8 voices</span>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">Sampler:</span>
                        <span class="info-value">ESP32-S3 @ 240MHz (PSRAM)</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Polyphony:</span>
                        <span class="info-value">8 voices</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Tracks:</span>
                        <span class="info-value" id="tracksInfo">8 tracks x 16 steps</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Output:</span>
                        <span class="info-value">I2S DAC + Internal DAC</span>
                    </div>
                </div>
            </section>

            <!-- Instruments Info Section -->
        <section id="section-instruments" class="device-info" data-section="instruments" data-title="Instrument Map">
            <div class="info-title">ü•Å SAMPLES LIBRARY</div>
            <div class="sample-browser">
                <div class="browser-header">
                    <div class="browser-title">üìö TODOS LOS SAMPLES</div>
                    <div class="sample-filters" id="sampleFilters"></div>
                </div>
                <div class="sample-filter-row">
                    <label class="sample-filter-label">ACTIVOS</label>
                    <label class="sample-toggle">
                        <input type="checkbox" id="sampleFilterActive">
                        <span class="sample-toggle-slider"></span>
                    </label>
                    <select id="sampleFilterFamily" class="sample-select"></select>
                    <select id="sampleFilterFormat" class="sample-select"></select>
                    <select id="sampleFilterRate" class="sample-select"></select>
                    <select id="sampleFilterChannels" class="sample-select"></select>
                </div>
                <div class="sample-browser-list" id="sampleBrowserList"></div>
            </div>
        </section>
        </div>
        <!-- Fin de Tabs -->

        <!-- Footer -->
        <footer class="footer">
            <p>RED808 | 16-Track Drum Machine | ESP32-S3 Dual Core | <button onclick="showKeyboardHelp()" style="background:none;border:1px solid #00ff88;color:#00ff88;padding:5px 10px;border-radius:3px;cursor:pointer;">‚å®Ô∏è Keyboard Shortcuts</button></p>
        </footer>
    </div>

    <script src="waveform-visualizer.js" defer></script>
    <script src="midi-import.js" defer></script>
    <script src="chat-agent.js?v=2" defer></script>
    <script src="app.js" defer></script>
    <script src="keyboard-controls.js" defer></script>
</body>
</html>
